--- #Koality: 1337
setup:
- scripts:
  #  pull down missing submodules
  - git submodule update --init --recursive
  # prepare database
  - ln -s $HOME/koality-v1/postgres $HOME/postgres
  #  uninstall old postgresql
  - psql --version | grep -q 9.3 || (apt-get remove -y postgresql && update-alternatives --remove postmaster.1.gz /usr/share/postgresql/9.1/man/man1/postmaster.1.gz && apt-get autoremove -y)
  # run chef
  - |
    echo '
    file_cache_path "/home/lt3/koality-v1/chef-cache"
    cookbook_path ["/home/lt3/koality-v1/chef/cookbooks", "/home/lt3/koality-v1/chef/site-cookbooks"]
    json_attribs "/home/lt3/koality-v1/chef-node.json"
    ' > chef-config.rb
  - |
    echo '{
      "run_list": ["recipe[apt]", "recipe[build-essential]", "recipe[postgres]", "recipe[golang]"],
      "go": {
        "version": "1.2",
        "gopath": "/home/lt3/koality-v1/code/back",
        "gobin": "/home/lt3/koality-v1/code/back/bin"
      }
    }' > chef-node.json
  - gem install chef --no-ri --no-rdoc -v 10.30.2
  - mkdir /home/lt3/koality-v1/chef-cache
  - chef-solo -c chef-config.rb
test:
  machines: 1
  factories:
  - koality test factory:
      script:
      - |
        cd code/back/src/koality
        ls -d */ | while read testDirectory; do
          echo - ${testDirectory%?}:
          echo "    script: go test koality/$testDirectory..."
        done
