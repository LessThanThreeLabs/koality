parameters:
  nodes: 2
sections:
- setup chicken:
    run on: all
    fail on: first
    scripts:
    #  pull down missing submodules
    - git submodule update --init --recursive
    # create repositories directory
    - sudo mkdir -p /etc/koality
    - sudo chmod -R 777 /etc/koality
      # run chef
    - |
      echo "
      file_cache_path \"$(pwd)/chef-cache\"
      cookbook_path [\"$(pwd)/chef/cookbooks\", \"$(pwd)/chef/site-cookbooks\"]
      json_attribs \"$(pwd)/chef-node.json\"
      " > chef-config.rb
    - |
      echo "{
        \"run_list\": [\"recipe[koality]\", \"recipe[apt]\", \"recipe[build-essential]\", \"recipe[postgres]\", \"recipe[golang]\"],
        \"go\": {
          \"version\": \"1.2\",
          \"gopath\": \"$(pwd)/code/back\",
          \"gobin\": \"$(pwd)/code/back/bin\"
        }
      }" > chef-node.json
    - rvmsudo gem install chef --no-ri --no-rdoc -v 10.30.2
    - mkdir -p $(pwd)/chef-cache
    - rvmsudo chef-solo -c chef-config.rb
- integration tests:
    run on: split
    fail on: any
    continue on failure: true
    scripts:
    - go build -v koality/...
    factories:
    - |
      cd code/back/src/koality
      ls -d */ | while read testDirectory; do
        echo "- ${testDirectory%?}:"
        echo "    command:"
        echo "    - go test -v koality/$testDirectory..."
      done
